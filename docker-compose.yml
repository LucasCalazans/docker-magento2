version: '2.2'

services:
    web:
        image: webjump/nginx:alpine
        env_file:
            - ./config.env
        ports:
            - 80:80
            - 443:443
        volumes:
            - ./logs/nginx:/var/log/nginx
            - ./config/nginx/conf.d/magento.conf:/etc/nginx/conf.d/magento.conf
            - ./config/nginx/conf.d/project.conf:/etc/nginx/conf.d/project.conf
            - ./config/magento/nginx.conf.sample:/etc/nginx/conf.d/nginx.conf.sample
            - ./web/html:/var/www/html
        networks:
            - front
            - back

    php:
        image: webjump/php:latest
        env_file:
            - ./config.env
        volumes:
            - ./logs/php:/var/log/php
            - ./logs/php/xdebug/:/var/log/php
            - ./config/magento/php.ini.sample:/usr/local/etc/php/php.ini
            - ./config/php/conf.d/xdebug.ini:/usr/local/etc/php/conf.d/docker-php-ext-xdebug.ini
            - ./config/php/conf.d/php.ini:/usr/local/etc/php/conf.d/docker-php-ext-error.ini
            - ./config/php/fpm/www.conf:/usr/local/etc/php-fpm.d/www.conf
            - ./config/php/bin/magento:/usr/local/bin/magento
            - ./web/html:/var/www/html
        depends_on:
            - web
            - database
        user: www-data
        networks:
            - back

    elasticsearch:
        # image: webjump/elasticsearch:build-test
        build:
            context: ./images/elasticsearch
        volumes:
            - elasticsearch_data:/usr/share/elasticsearch/data
            - ./logs/elasticsearch:/var/log/elasticsearch
            - ./config/elasticsearch/elasticsearch.yml:/usr/share/elasticsearch/config/elasticsearch.yml
        depends_on:
            - web
            - database
            - php
        environment:
            - http.host=0.0.0.0
            - transport.host=localhost
            - "ES_JAVA_OPTS=-Xms512m -Xmx512m"
        mem_limit: 1g
        ulimits:
            memlock:
                soft: -1
                hard: -1
        ports:
            - 9200:9200
            - 9300:9300
        networks:
            - back

    database:
        image: percona:5.7.19
        working_dir: /dump
        env_file:
            - ./config.env
        ports:
            - 3306:3306
        volumes:
            - database_data:/var/lib/mysql
            - ./dump:/dump
        networks:
            - back

    cache:
        image: redis:alpine
        env_file:
            - ./config.env
        networks:
            - back

    session:
        image: redis:alpine
        env_file:
            - ./config.env
        networks:
            - back

    phpmyadmin:
        image: phpmyadmin/phpmyadmin:latest
        depends_on:
            - database
        env_file:
            - ./config.env
        ports:
            - 8080:80
        networks:
            - front
            - back

networks:
    front:
        driver: bridge
    back:
        driver: bridge

volumes:
    database_data:
        driver: local
    elasticsearch_data:
        driver: local
